<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!--
        Désactiver le template original de adi_team_header
        et le remplacer par notre version configurable
    -->
    <record id="adi_team_header.external_layout_custom_header" model="ir.ui.view">
        <field name="active" eval="False"/>
    </record>

    <!--
        Notre template qui remplace adi_team_header
        Hérite directement de web.external_layout_standard
    -->
    <template id="external_layout_custom_styled" inherit_id="web.external_layout_standard">
        <xpath expr="//div[@name='company_address']" position="replace">
            <!-- Vérifier si le template personnalisé est activé -->
            <t t-set="use_custom" t-value="company.use_custom_report_template if company else False"/>

            <t t-if="use_custom">
                <!-- Déterminer le style à utiliser -->
                <t t-set="template_style" t-value="company.report_template_style or 'light'"/>
                <t t-set="fiscal_in_footer" t-value="company.fiscal_info_in_footer"/>

                <!-- Appeler le template selon le style -->
                <t t-if="template_style == 'box'">
                    <t t-call="adi_report_template_config.header_style_box">
                        <t t-set="fiscal_in_footer" t-value="fiscal_in_footer"/>
                    </t>
                </t>
                <t t-elif="template_style == 'bold'">
                    <t t-call="adi_report_template_config.header_style_bold">
                        <t t-set="fiscal_in_footer" t-value="fiscal_in_footer"/>
                    </t>
                </t>
                <t t-else="">
                    <t t-call="adi_report_template_config.header_style_light">
                        <t t-set="fiscal_in_footer" t-value="fiscal_in_footer"/>
                    </t>
                </t>
            </t>

            <!-- Si template personnalisé désactivé, utiliser le comportement original de adi_team_header -->
            <t t-else="">
                <t t-call="adi_report_template_config.header_original_fallback"/>
            </t>
        </xpath>
    </template>

    <!-- ============================================ -->
    <!-- Helper: Récupérer l'équipe depuis le document -->
    <!-- ============================================ -->
    <template id="get_team_helper">
        <!-- Récupérer l'équipe si disponible selon le type de document -->
        <t t-set="team" t-value="False"/>
        <t t-if="docs and len(docs) > 0">
            <!-- Sale Order -->
            <t t-if="docs[0]._name == 'sale.order'">
                <t t-set="team" t-value="docs[0].team_id if docs[0].team_id else False"/>
            </t>
            <!-- Account Move (Facture) -->
            <t t-elif="docs[0]._name == 'account.move'">
                <t t-set="team" t-value="docs[0].team_id if hasattr(docs[0], 'team_id') and docs[0].team_id else False"/>
            </t>
            <!-- Stock Picking (Bon de livraison) -->
            <t t-elif="docs[0]._name == 'stock.picking'">
                <t t-set="team" t-value="docs[0].sale_id.team_id if docs[0].sale_id and docs[0].sale_id.team_id else False"/>
            </t>
        </t>
    </template>

    <!-- ============================================ -->
    <!-- STYLE LIGHT - Épuré et minimaliste          -->
    <!-- ============================================ -->
    <template id="header_style_light">
        <!-- Récupérer l'équipe -->
        <t t-set="team" t-value="False"/>
        <t t-if="docs and len(docs) > 0">
            <t t-if="docs[0]._name == 'sale.order' and docs[0].team_id">
                <t t-set="team" t-value="docs[0].team_id"/>
            </t>
            <t t-elif="docs[0]._name == 'account.move' and hasattr(docs[0], 'team_id') and docs[0].team_id">
                <t t-set="team" t-value="docs[0].team_id"/>
            </t>
            <t t-elif="docs[0]._name == 'stock.picking' and docs[0].sale_id and docs[0].sale_id.team_id">
                <t t-set="team" t-value="docs[0].sale_id.team_id"/>
            </t>
        </t>

        <div name="company_address" style="display: inline-block;">
            <p style="font-size: 9pt; line-height: 1.4; color: #333;">
                <!-- Adresse : équipe si disponible, sinon société -->
                <t t-if="team and team.team_address">
                    <span t-field="team.team_address"/><br/>
                </t>
                <t t-elif="company.street">
                    <span t-field="company.street"/><br/>
                </t>

                <!-- Description : équipe si disponible, sinon société -->
                <t t-if="team and team.team_description">
                    <span t-field="team.team_description" style="font-style: italic;"/><br/>
                </t>
                <t t-elif="hasattr(company, 'activity_description') and company.activity_description">
                    <span t-field="company.activity_description" style="font-style: italic;"/><br/>
                </t>

                <!-- Infos fiscales (si pas en footer) : équipe si disponible, sinon société -->
                <t t-if="not fiscal_in_footer">
                    <span style="font-size: 8pt; color: #6c757d;">
                        <t t-if="team">
                            <t t-if="team.rc">R.C: <t t-esc="team.rc"/></t>
                            <t t-if="team.rc and (team.ai or team.nif or team.nis)"> - </t>
                            <t t-if="team.ai">A.I: <t t-esc="team.ai"/></t>
                            <t t-if="team.ai and (team.nif or team.nis)"> - </t>
                            <t t-if="team.nif">N.I.F: <t t-esc="team.nif"/></t>
                            <t t-if="team.nif and team.nis"> - </t>
                            <t t-if="team.nis">N.I.S: <t t-esc="team.nis"/></t>
                        </t>
                        <t t-else="">
                            <t t-if="hasattr(company, 'rc') and company.rc">R.C: <t t-esc="company.rc"/></t>
                            <t t-if="hasattr(company, 'rc') and company.rc and (hasattr(company, 'ai') and company.ai or hasattr(company, 'nif') and company.nif or hasattr(company, 'nis') and company.nis)"> - </t>
                            <t t-if="hasattr(company, 'ai') and company.ai">A.I: <t t-esc="company.ai"/></t>
                            <t t-if="hasattr(company, 'ai') and company.ai and (hasattr(company, 'nif') and company.nif or hasattr(company, 'nis') and company.nis)"> - </t>
                            <t t-if="hasattr(company, 'nif') and company.nif">N.I.F: <t t-esc="company.nif"/></t>
                            <t t-if="hasattr(company, 'nif') and company.nif and hasattr(company, 'nis') and company.nis"> - </t>
                            <t t-if="hasattr(company, 'nis') and company.nis">N.I.S: <t t-esc="company.nis"/></t>
                        </t>
                    </span>
                    <br/>
                </t>

                <!-- Email : équipe si disponible, sinon société -->
                <t t-if="team and team.email">
                    <span t-field="team.email"/><br/>
                </t>
                <t t-elif="company.email">
                    <span t-field="company.email"/><br/>
                </t>

                <!-- Téléphone : équipe si disponible, sinon société -->
                <t t-if="team and team.tel">
                    <span t-field="team.tel"/>
                </t>
                <t t-elif="company.phone">
                    <span t-field="company.phone"/>
                </t>
            </p>
        </div>
    </template>

    <!-- ============================================ -->
    <!-- STYLE BOX - Encadré avec bordures           -->
    <!-- ============================================ -->
    <template id="header_style_box">
        <!-- Récupérer l'équipe -->
        <t t-set="team" t-value="False"/>
        <t t-if="docs and len(docs) > 0">
            <t t-if="docs[0]._name == 'sale.order' and docs[0].team_id">
                <t t-set="team" t-value="docs[0].team_id"/>
            </t>
            <t t-elif="docs[0]._name == 'account.move' and hasattr(docs[0], 'team_id') and docs[0].team_id">
                <t t-set="team" t-value="docs[0].team_id"/>
            </t>
            <t t-elif="docs[0]._name == 'stock.picking' and docs[0].sale_id and docs[0].sale_id.team_id">
                <t t-set="team" t-value="docs[0].sale_id.team_id"/>
            </t>
        </t>

        <div name="company_address" style="display: inline-block;">
            <div style="border: 1px solid #dee2e6; border-radius: 4px; padding: 8px; background-color: #f8f9fa;">
                <table style="font-size: 9pt; width: 100%;">
                    <!-- Adresse -->
                    <tr t-if="(team and team.team_address) or company.street">
                        <td style="padding: 2px 0;">
                            <span style="color: #6c757d; margin-right: 5px;">&#128205;</span>
                            <t t-if="team and team.team_address">
                                <span t-field="team.team_address"/>
                            </t>
                            <t t-else="">
                                <span t-field="company.street"/>
                            </t>
                        </td>
                    </tr>
                    <!-- Description -->
                    <tr t-if="(team and team.team_description) or (hasattr(company, 'activity_description') and company.activity_description)">
                        <td style="padding: 2px 0; font-style: italic; color: #6c757d;">
                            <span style="margin-right: 5px;">&#9432;</span>
                            <t t-if="team and team.team_description">
                                <span t-field="team.team_description"/>
                            </t>
                            <t t-else="">
                                <span t-field="company.activity_description"/>
                            </t>
                        </td>
                    </tr>
                    <!-- Infos fiscales (si pas en footer) -->
                    <tr t-if="not fiscal_in_footer">
                        <td style="padding: 4px 0; border-top: 1px dashed #dee2e6; font-size: 8pt; color: #6c757d;">
                            <t t-if="team">
                                <t t-if="team.rc">R.C: <t t-esc="team.rc"/></t>
                                <t t-if="team.rc and (team.ai or team.nif or team.nis)"> - </t>
                                <t t-if="team.ai">A.I: <t t-esc="team.ai"/></t>
                                <t t-if="team.ai and (team.nif or team.nis)"> - </t>
                                <t t-if="team.nif">N.I.F: <t t-esc="team.nif"/></t>
                                <t t-if="team.nif and team.nis"> - </t>
                                <t t-if="team.nis">N.I.S: <t t-esc="team.nis"/></t>
                            </t>
                            <t t-else="">
                                <t t-if="hasattr(company, 'rc') and company.rc">R.C: <t t-esc="company.rc"/></t>
                                <t t-if="hasattr(company, 'rc') and company.rc and (hasattr(company, 'ai') and company.ai or hasattr(company, 'nif') and company.nif or hasattr(company, 'nis') and company.nis)"> - </t>
                                <t t-if="hasattr(company, 'ai') and company.ai">A.I: <t t-esc="company.ai"/></t>
                                <t t-if="hasattr(company, 'ai') and company.ai and (hasattr(company, 'nif') and company.nif or hasattr(company, 'nis') and company.nis)"> - </t>
                                <t t-if="hasattr(company, 'nif') and company.nif">N.I.F: <t t-esc="company.nif"/></t>
                                <t t-if="hasattr(company, 'nif') and company.nif and hasattr(company, 'nis') and company.nis"> - </t>
                                <t t-if="hasattr(company, 'nis') and company.nis">N.I.S: <t t-esc="company.nis"/></t>
                            </t>
                        </td>
                    </tr>
                    <!-- Email -->
                    <tr t-if="(team and team.email) or company.email">
                        <td style="padding: 2px 0;">
                            <span style="color: #6c757d; margin-right: 5px;">&#9993;</span>
                            <t t-if="team and team.email">
                                <span t-field="team.email"/>
                            </t>
                            <t t-else="">
                                <span t-field="company.email"/>
                            </t>
                        </td>
                    </tr>
                    <!-- Téléphone -->
                    <tr t-if="(team and team.tel) or company.phone">
                        <td style="padding: 2px 0;">
                            <span style="color: #6c757d; margin-right: 5px;">&#9742;</span>
                            <t t-if="team and team.tel">
                                <span t-field="team.tel"/>
                            </t>
                            <t t-else="">
                                <span t-field="company.phone"/>
                            </t>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </template>

    <!-- ============================================ -->
    <!-- STYLE BOLD - Mise en forme prononcée        -->
    <!-- ============================================ -->
    <template id="header_style_bold">
        <!-- Récupérer l'équipe -->
        <t t-set="team" t-value="False"/>
        <t t-if="docs and len(docs) > 0">
            <t t-if="docs[0]._name == 'sale.order' and docs[0].team_id">
                <t t-set="team" t-value="docs[0].team_id"/>
            </t>
            <t t-elif="docs[0]._name == 'account.move' and hasattr(docs[0], 'team_id') and docs[0].team_id">
                <t t-set="team" t-value="docs[0].team_id"/>
            </t>
            <t t-elif="docs[0]._name == 'stock.picking' and docs[0].sale_id and docs[0].sale_id.team_id">
                <t t-set="team" t-value="docs[0].sale_id.team_id"/>
            </t>
        </t>

        <div name="company_address" style="display: inline-block;">
            <div style="font-size: 9pt;">
                <!-- Adresse en gras -->
                <p t-if="(team and team.team_address) or company.street"
                   style="margin: 0 0 4px 0; font-weight: bold; color: #212529;">
                    <t t-if="team and team.team_address">
                        <span t-field="team.team_address"/>
                    </t>
                    <t t-else="">
                        <span t-field="company.street"/>
                    </t>
                </p>

                <!-- Description -->
                <p t-if="(team and team.team_description) or (hasattr(company, 'activity_description') and company.activity_description)"
                   style="margin: 0 0 4px 0; font-style: italic; color: #495057;">
                    <t t-if="team and team.team_description">
                        <span t-field="team.team_description"/>
                    </t>
                    <t t-else="">
                        <span t-field="company.activity_description"/>
                    </t>
                </p>

                <!-- Infos fiscales (si pas en footer) -->
                <p t-if="not fiscal_in_footer" style="margin: 0 0 4px 0; font-size: 8pt; color: #6c757d;">
                    <t t-if="team">
                        <t t-if="team.rc">R.C: <t t-esc="team.rc"/></t>
                        <t t-if="team.rc and (team.ai or team.nif or team.nis)"> - </t>
                        <t t-if="team.ai">A.I: <t t-esc="team.ai"/></t>
                        <t t-if="team.ai and (team.nif or team.nis)"> - </t>
                        <t t-if="team.nif">N.I.F: <t t-esc="team.nif"/></t>
                        <t t-if="team.nif and team.nis"> - </t>
                        <t t-if="team.nis">N.I.S: <t t-esc="team.nis"/></t>
                    </t>
                    <t t-else="">
                        <t t-if="hasattr(company, 'rc') and company.rc">R.C: <t t-esc="company.rc"/></t>
                        <t t-if="hasattr(company, 'rc') and company.rc and (hasattr(company, 'ai') and company.ai or hasattr(company, 'nif') and company.nif or hasattr(company, 'nis') and company.nis)"> - </t>
                        <t t-if="hasattr(company, 'ai') and company.ai">A.I: <t t-esc="company.ai"/></t>
                        <t t-if="hasattr(company, 'ai') and company.ai and (hasattr(company, 'nif') and company.nif or hasattr(company, 'nis') and company.nis)"> - </t>
                        <t t-if="hasattr(company, 'nif') and company.nif">N.I.F: <t t-esc="company.nif"/></t>
                        <t t-if="hasattr(company, 'nif') and company.nif and hasattr(company, 'nis') and company.nis"> - </t>
                        <t t-if="hasattr(company, 'nis') and company.nis">N.I.S: <t t-esc="company.nis"/></t>
                    </t>
                </p>

                <!-- Contact avec labels en gras -->
                <p style="margin: 0;">
                    <t t-if="(team and team.email) or company.email">
                        <strong>Email:</strong>
                        <t t-if="team and team.email">
                            <span t-field="team.email"/>
                        </t>
                        <t t-else="">
                            <span t-field="company.email"/>
                        </t>
                        <br/>
                    </t>
                    <t t-if="(team and team.tel) or company.phone">
                        <strong>Tél:</strong>
                        <t t-if="team and team.tel">
                            <span t-field="team.tel"/>
                        </t>
                        <t t-else="">
                            <span t-field="company.phone"/>
                        </t>
                    </t>
                </p>
            </div>
        </div>
    </template>

    <!-- ============================================ -->
    <!-- Fallback vers le template original          -->
    <!-- (Reproduit le comportement de adi_team_header avec fallback société) -->
    <!-- ============================================ -->
    <template id="header_original_fallback">
        <!-- Récupérer l'équipe selon le type de document -->
        <t t-set="team" t-value="False"/>
        <t t-if="docs and len(docs) > 0">
            <t t-if="docs[0]._name == 'sale.order' and docs[0].team_id">
                <t t-set="team" t-value="docs[0].team_id"/>
            </t>
            <t t-elif="docs[0]._name == 'account.move' and hasattr(docs[0], 'team_id') and docs[0].team_id">
                <t t-set="team" t-value="docs[0].team_id"/>
            </t>
            <t t-elif="docs[0]._name == 'stock.picking' and docs[0].sale_id and docs[0].sale_id.team_id">
                <t t-set="team" t-value="docs[0].sale_id.team_id"/>
            </t>
        </t>

        <div name="company_address" style="display: inline-block;">
            <p>
                <!-- Si équipe avec infos, afficher les infos de l'équipe -->
                <t t-if="team and (team.team_address or team.email or team.tel)">
                    <t t-if="team.team_address">
                        <span t-field="team.team_address"/><br/>
                    </t>
                    <t t-if="team.team_description">
                        <span t-field="team.team_description"/><br/>
                    </t>
                    <t t-if="team.rc"><span t-field="team.rc"/> - </t>
                    <t t-if="team.ai"><span t-field="team.ai"/> - </t>
                    <t t-if="team.nif"><span t-field="team.nif"/> - </t>
                    <t t-if="team.nis"><span t-field="team.nis"/></t>
                    <t t-if="team.rc or team.ai or team.nif or team.nis"><br/></t>
                    <t t-if="team.email">
                        <span t-field="team.email"/><br/>
                    </t>
                    <t t-if="team.tel">
                        <span t-field="team.tel"/>
                    </t>
                </t>
                <!-- Sinon, afficher les infos de la société -->
                <t t-else="">
                    <t t-if="hasattr(company, 'activity_description') and company.activity_description">
                        <span t-field="company.activity_description"/><br/>
                    </t>
                    <t t-if="company.street">
                        <span t-field="company.street"/><br/>
                    </t>
                    <t t-if="hasattr(company, 'rc') and company.rc">RC: <span t-field="company.rc"/> - </t>
                    <t t-if="hasattr(company, 'ai') and company.ai">AI: <span t-field="company.ai"/> - </t>
                    <t t-if="hasattr(company, 'nif') and company.nif">NIF: <span t-field="company.nif"/> - </t>
                    <t t-if="hasattr(company, 'nis') and company.nis">NIS: <span t-field="company.nis"/></t>
                    <t t-if="(hasattr(company, 'rc') and company.rc) or (hasattr(company, 'ai') and company.ai) or (hasattr(company, 'nif') and company.nif) or (hasattr(company, 'nis') and company.nis)"><br/></t>
                    <t t-if="company.email">
                        <span t-field="company.email"/><br/>
                    </t>
                    <t t-if="company.phone">
                        <span t-field="company.phone"/>
                    </t>
                </t>
            </p>
        </div>
    </template>

</odoo>
