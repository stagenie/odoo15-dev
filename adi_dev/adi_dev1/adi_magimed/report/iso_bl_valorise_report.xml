<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- ISO BL Valorise Report Action -->
        <record id="action_report_iso_bl_valorise" model="ir.actions.report">
            <field name="name">ISO BL Valorise</field>
            <field name="model">stock.picking</field>
            <field name="report_type">qweb-pdf</field>
            <field name="report_name">adi_magimed.report_iso_bl_valorise</field>
            <field name="report_file">adi_magimed.report_iso_bl_valorise</field>
            <field name="print_report_name">'ISO_BL_Valorise_%s' % object.name.replace('/', '_')</field>
            <field name="binding_model_id" ref="stock.model_stock_picking"/>
            <field name="binding_type">report</field>
            <field name="paperformat_id" ref="paperformat_magimed"/>
        </record>

        <!-- ISO BL Valorise Report Template -->
        <template id="report_iso_bl_valorise">
            <t t-call="web.html_container">
                <t t-foreach="docs" t-as="o">
                    <t t-call="web.external_layout">
                        <t t-set="o" t-value="o.with_context(lang=o.partner_id.lang)"/>
                        <t t-set="partner" t-value="o.partner_id or (o.move_lines and o.move_lines[0].partner_id) or False"/>
                        <t t-set="currency" t-value="o.company_id.currency_id"/>

                        <div class="page">
                            <table style="font-size: 18px;" width="100%" class="table table-borderless">
                                <tr>
                                    <td class="text-left" width="65%">
                                        <strong>
                                            <span>Bon de Livraison Valorise ISO N° : </span>
                                            <span t-field="o.name"/>
                                        </strong>
                                        <div name="customer">
                                            <div>
                                                <strong>Client : </strong>
                                                <span t-field="o.partner_id.name"/>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-end">
                                        <div t-if="o.state" name="div_sched_date">
                                            <strong>Date: </strong>
                                            <t t-if="o.state == 'done'">
                                                <span t-field="o.date_done"/>
                                            </t>
                                            <t t-if="o.state != 'done'">
                                                <span t-field="o.scheduled_date"/>
                                            </t>
                                        </div>
                                        <t t-if="o.move_lines and o.move_lines[0].sale_line_id.order_id">
                                            <div name="div_user_v">
                                                <strong>Commercial : </strong>
                                                <span t-field="o.move_lines[0].sale_line_id.order_id.user_id"/>
                                            </div>
                                        </t>
                                    </td>
                                </tr>
                            </table>

                            <t t-set="number_ligne" t-value="0"/>
                            <t t-set="amount_total" t-value="0"/>
                            <t t-set="amount_total_ttc" t-value="0"/>
                            <t t-set="amount_total_tva" t-value="0"/>
                            <t t-set="has_sale" t-value="o.move_lines and o.move_lines[0].sale_line_id.order_id"/>
                            <!-- Check if any line has a discount -->
                            <t t-set="has_discount" t-value="any(ml.move_id.sale_line_id.discount for ml in o.move_line_ids_without_package if ml.move_id.sale_line_id)"/>

                            <table class="table table-sm o_main_table" name="iso_bl_val_table">
                                <thead>
                                    <tr>
                                        <th style="width: 4%;"><strong>N°</strong></th>
                                        <th><strong>Description</strong></th>
                                        <th style="width: 12%;"><strong>N° Lot</strong></th>
                                        <th style="width: 10%;"><strong>Date Exp.</strong></th>
                                        <th style="width: 8%;" class="text-center"><strong>Qte</strong></th>
                                        <th style="width: 7%;"><strong>Unite</strong></th>
                                        <t t-if="has_sale">
                                            <th style="width: 10%;" class="text-right"><strong>P.U.</strong></th>
                                            <t t-if="has_discount">
                                                <th style="width: 6%;" class="text-center"><strong>Rem%</strong></th>
                                                <th style="width: 10%;" class="text-right"><strong>PU Remise</strong></th>
                                            </t>
                                            <th style="width: 12%;" class="text-right"><strong>Montant HT</strong></th>
                                        </t>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="o.move_line_ids_without_package" t-as="line">
                                        <t t-set="number_ligne" t-value="number_ligne + 1"/>
                                        <t t-set="sale_line" t-value="line.move_id.sale_line_id"/>
                                        <t t-set="price_unit" t-value="sale_line.price_unit if sale_line else 0"/>
                                        <t t-set="discount" t-value="sale_line.discount if sale_line else 0"/>
                                        <t t-set="discounted_price" t-value="price_unit * (1 - discount / 100.0)"/>
                                        <t t-set="line_amount" t-value="discounted_price * line.qty_done"/>

                                        <t t-if="has_sale">
                                            <t t-set="amount_total" t-value="amount_total + line_amount"/>
                                            <t t-set="total_tva_rate" t-value="0"/>
                                            <t t-if="sale_line and sale_line.tax_id">
                                                <t t-foreach="sale_line.tax_id" t-as="ltva">
                                                    <t t-set="total_tva_rate" t-value="total_tva_rate + ltva.amount / 100"/>
                                                </t>
                                            </t>
                                            <t t-set="tva_mult" t-value="(1 + total_tva_rate) if (sale_line and sale_line.tax_id) else 1"/>
                                            <t t-set="line_ttc" t-value="line_amount * tva_mult"/>
                                            <t t-set="amount_total_ttc" t-value="amount_total_ttc + line_ttc"/>
                                            <t t-set="amount_total_tva" t-value="amount_total_tva + (line_ttc - line_amount)"/>
                                        </t>

                                        <tr>
                                            <td><span t-esc="number_ligne"/></td>
                                            <td>
                                                <span t-field="line.product_id"/>
                                            </td>
                                            <td>
                                                <t t-if="line.lot_id">
                                                    <strong><span t-field="line.lot_id.name"/></strong>
                                                </t>
                                                <t t-elif="line.lot_name">
                                                    <span t-esc="line.lot_name"/>
                                                </t>
                                                <t t-else="">-</t>
                                            </td>
                                            <td>
                                                <t t-if="line.lot_id.expiration_date">
                                                    <span t-field="line.lot_id.expiration_date" t-options="{'widget': 'date'}"/>
                                                </t>
                                                <t t-else="">-</t>
                                            </td>
                                            <td class="text-center">
                                                <span t-field="line.qty_done"/>
                                            </td>
                                            <td>
                                                <span t-field="line.product_uom_id"/>
                                            </td>
                                            <t t-if="has_sale">
                                                <td class="text-right">
                                                    <span t-esc="price_unit" t-options='{"widget": "monetary", "display_currency": currency}'/>
                                                </td>
                                                <t t-if="has_discount">
                                                    <td class="text-center">
                                                        <t t-if="discount">
                                                            <span t-esc="discount" t-options='{"widget": "float", "precision": 2}'/>%
                                                        </t>
                                                    </td>
                                                    <td class="text-right">
                                                        <span t-esc="discounted_price" t-options='{"widget": "monetary", "display_currency": currency}'/>
                                                    </td>
                                                </t>
                                                <td class="text-right">
                                                    <span t-esc="line_amount" t-options='{"widget": "monetary", "display_currency": currency}'/>
                                                </td>
                                            </t>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>

                            <!-- Totals -->
                            <t t-if="has_sale">
                                <div class="row" style="page-break-inside: avoid;">
                                    <div class="col-12">
                                        <div style="float: right; width: 300px;" class="mt-4">
                                            <table class="table table-sm" style="border: 1px solid #dee2e6;">
                                                <tr class="border-bottom">
                                                    <td class="text-right"><strong>Total HT</strong></td>
                                                    <td class="text-right">
                                                        <span t-esc="amount_total" t-options='{"widget": "monetary", "display_currency": currency}'/>
                                                    </td>
                                                </tr>
                                                <tr class="border-bottom">
                                                    <td class="text-right"><strong>TVA</strong></td>
                                                    <td class="text-right">
                                                        <span t-esc="amount_total_tva" t-options='{"widget": "monetary", "display_currency": currency}'/>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="text-right"><strong>Total TTC</strong></td>
                                                    <td class="text-right">
                                                        <span t-esc="amount_total_ttc" t-options='{"widget": "monetary", "display_currency": currency}'/>
                                                    </td>
                                                </tr>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </t>

                        </div>
                    </t>
                </t>
            </t>
        </template>

    </data>
</odoo>
