<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- Expiration Alert Report Action -->
        <record id="action_report_expiration_alert" model="ir.actions.report">
            <field name="name">Alertes Expiration</field>
            <field name="model">stock.production.lot</field>
            <field name="report_type">qweb-pdf</field>
            <field name="report_name">adi_magimed.report_expiration_alert</field>
            <field name="report_file">adi_magimed.report_expiration_alert</field>
            <field name="print_report_name">'Alertes_Expiration_%s' % time.strftime('%Y%m%d')</field>
            <field name="binding_model_id" ref="stock.model_stock_production_lot"/>
            <field name="binding_type">report</field>
            <field name="paperformat_id" ref="paperformat_magimed"/>
        </record>

        <!-- Expiration Alert Report Template -->
        <template id="report_expiration_alert">
            <t t-call="web.html_container">
                <t t-call="web.external_layout">
                    <div class="page">
                        <div class="text-center">
                            <h2 style="color: #e74c3c;">ALERTES EXPIRATION</h2>
                            <p class="small">
                                Edite le: <span t-esc="time.strftime('%d/%m/%Y %H:%M')"/>
                            </p>
                        </div>

                        <!-- Summary Box -->
                        <div class="row mt-4 mb-4">
                            <div class="col-3 text-center">
                                <div class="card border-danger">
                                    <div class="card-body p-2">
                                        <h5 class="text-danger mb-0">
                                            <t t-esc="len([l for l in docs if l.expiration_status == 'expired'])"/>
                                        </h5>
                                        <small>Expires</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-3 text-center">
                                <div class="card border-warning">
                                    <div class="card-body p-2">
                                        <h5 class="text-warning mb-0">
                                            <t t-esc="len([l for l in docs if l.expiration_status == 'danger'])"/>
                                        </h5>
                                        <small>Urgents (&lt;7j)</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-3 text-center">
                                <div class="card border-info">
                                    <div class="card-body p-2">
                                        <h5 class="text-info mb-0">
                                            <t t-esc="len([l for l in docs if l.expiration_status == 'warning'])"/>
                                        </h5>
                                        <small>Attention</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-3 text-center">
                                <div class="card">
                                    <div class="card-body p-2">
                                        <h5 class="mb-0">
                                            <t t-esc="len(docs)"/>
                                        </h5>
                                        <small>Total</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <table class="table table-sm table-bordered">
                            <thead class="thead-dark">
                                <tr>
                                    <th style="width: 15%;">N Lot</th>
                                    <th style="width: 25%;">Produit</th>
                                    <th style="width: 12%;">Expiration</th>
                                    <th style="width: 10%;" class="text-center">Jours</th>
                                    <th style="width: 10%;" class="text-center">Quantite</th>
                                    <th style="width: 8%;">Unite</th>
                                    <th style="width: 20%;">Emplacements</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="docs.sorted(key=lambda l: l.days_to_expiration)" t-as="lot">
                                    <tr t-attf-class="#{lot.expiration_status == 'expired' and 'table-danger' or lot.expiration_status == 'danger' and 'table-warning' or ''}">
                                        <td>
                                            <t t-if="lot.expiration_status in ('expired', 'danger')">
                                                <strong style="color: #e74c3c;">!</strong>
                                            </t>
                                            <strong t-field="lot.name"/>
                                        </td>
                                        <td>
                                            <span t-field="lot.product_id.name"/>
                                            <br/>
                                            <small class="text-muted" t-field="lot.product_id.default_code"/>
                                        </td>
                                        <td>
                                            <span t-field="lot.expiration_date" t-options="{'widget': 'date'}"/>
                                        </td>
                                        <td class="text-center">
                                            <t t-if="lot.days_to_expiration &lt; 0">
                                                <span class="badge badge-dark">
                                                    <t t-esc="abs(lot.days_to_expiration)"/>j passe
                                                </span>
                                            </t>
                                            <t t-elif="lot.days_to_expiration &lt;= 7">
                                                <span class="badge badge-danger">
                                                    <t t-esc="lot.days_to_expiration"/>j
                                                </span>
                                            </t>
                                            <t t-elif="lot.days_to_expiration &lt;= 30">
                                                <span class="badge badge-warning">
                                                    <t t-esc="lot.days_to_expiration"/>j
                                                </span>
                                            </t>
                                            <t t-else="">
                                                <span class="badge badge-info">
                                                    <t t-esc="lot.days_to_expiration"/>j
                                                </span>
                                            </t>
                                        </td>
                                        <td class="text-center">
                                            <strong t-field="lot.total_qty"/>
                                        </td>
                                        <td><span t-field="lot.product_uom_id.name"/></td>
                                        <td class="small">
                                            <t t-esc="lot.location_qty_info"/>
                                        </td>
                                    </tr>
                                </t>
                            </tbody>
                        </table>

                        <div class="row mt-4">
                            <div class="col-6">
                                <p class="small"><strong>Legende:</strong></p>
                                <ul class="small">
                                    <li><span class="badge badge-dark">Expire</span> - Lot depasse la date d'expiration</li>
                                    <li><span class="badge badge-danger">Urgent</span> - Expire dans moins de 7 jours</li>
                                    <li><span class="badge badge-warning">Attention</span> - Expire dans moins de 30 jours</li>
                                </ul>
                            </div>
                            <div class="col-6 text-right">
                                <p class="small">
                                    <strong>Responsable:</strong> ________________________
                                </p>
                                <p class="small">
                                    <strong>Date:</strong> ___/___/_____
                                </p>
                            </div>
                        </div>
                    </div>
                </t>
            </t>
        </template>

    </data>
</odoo>
