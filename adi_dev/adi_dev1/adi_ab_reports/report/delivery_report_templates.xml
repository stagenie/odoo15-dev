<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Template pour le Bon de livraison -->
    <template id="report_delivery_document_ab" inherit_id="stock.report_delivery_document">

        <!-- Modifier le titre pour afficher "Bon de livraison" -->
        <xpath expr="//h2" position="replace">
            <h2>
                <span>Bon de livraison</span>
                <span t-if="o.name">
                    - <span t-field="o.name"/>
                </span>
            </h2>
        </xpath>

        <!-- Enlever "Facture de vente" si présent -->
        <xpath expr="//span[contains(text(), 'Facture de vente')]" position="replace">
            <!-- Supprimé -->
        </xpath>
    </template>

    <!-- Template pour le Bon de livraison valorisé (Vente BL) -->
    <template id="report_picking_with_price_ab" inherit_id="stock.report_picking">

        <!-- Modifier le titre -->
        <xpath expr="//t[@t-call='stock.report_delivery_document']" position="before">
            <t t-set="is_valued_picking" t-value="True"/>
        </xpath>
    </template>

    <!-- Template personnalisé pour le BL valorisé -->
    <template id="report_delivery_valued_document_ab">
        <t t-call="web.external_layout">
            <t t-set="o" t-value="o.with_context(lang=o.partner_id.lang)"/>
            <div class="page">
                <div class="oe_structure"/>

                <div class="row">
                    <div class="col-7">
                        <h2>
                            <span>Vente BL</span>
                            <span t-if="o.name"> - <span t-field="o.name"/></span>
                        </h2>
                    </div>
                    <div class="col-5">
                        <div class="row">
                            <div class="col-6">
                                <strong>Date:</strong>
                            </div>
                            <div class="col-6">
                                <span t-field="o.scheduled_date"/>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-6">
                        <strong>Client:</strong>
                        <div t-field="o.partner_id" t-options='{"widget": "contact", "fields": ["address", "name", "phone"], "no_marker": True}'/>
                    </div>
                </div>

                <!-- Table des produits avec prix TTC -->
                <table class="table table-sm o_main_table mt-4">
                    <thead>
                        <tr>
                            <th name="th_sm_product"><span>Produit</span></th>
                            <th name="th_sm_quantity" class="text-center"><span>Quantité</span></th>
                            <th name="th_sm_uom" class="text-center"><span>Unité</span></th>
                            <th name="th_sm_price_unit" class="text-end"><span>Prix TTC</span></th>
                            <th name="th_sm_price_total" class="text-end"><span>Total TTC</span></th>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-foreach="o.move_ids_without_package" t-as="move">
                            <tr>
                                <td><span t-field="move.product_id.display_name"/></td>
                                <td class="text-center">
                                    <span t-field="move.product_uom_qty"/>
                                </td>
                                <td class="text-center">
                                    <span t-field="move.product_uom"/>
                                </td>
                                <td class="text-end">
                                    <t t-if="move.sale_line_id">
                                        <span t-field="move.sale_line_id.price_unit"
                                              t-options='{"widget": "monetary", "display_currency": move.sale_line_id.currency_id}'/>
                                    </t>
                                </td>
                                <td class="text-end">
                                    <t t-if="move.sale_line_id">
                                        <span t-field="move.sale_line_id.price_total"
                                              t-options='{"widget": "monetary", "display_currency": move.sale_line_id.currency_id}'/>
                                    </t>
                                </td>
                            </tr>
                        </t>
                    </tbody>
                </table>

                <!-- Total Net à payer -->
                <div class="row">
                    <div class="col-6 offset-6">
                        <table class="table table-sm table-borderless">
                            <tr class="border-black o_total">
                                <td><strong>Net à payer</strong></td>
                                <td class="text-end">
                                    <t t-if="o.sale_id">
                                        <span t-field="o.sale_id.amount_total"
                                              t-options='{"widget": "monetary", "display_currency": o.sale_id.currency_id}'/>
                                    </t>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>

                <div class="oe_structure"/>
            </div>
        </t>
    </template>

    <!-- Définir le rapport pour le BL valorisé -->
    <record id="action_report_delivery_valued_ab" model="ir.actions.report">
        <field name="name">Vente BL</field>
        <field name="model">stock.picking</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">adi_ab_reports.report_delivery_valued_document_ab</field>
        <field name="report_file">adi_ab_reports.report_delivery_valued_document_ab</field>
        <field name="binding_model_id" ref="stock.model_stock_picking"/>
        <field name="binding_type">report</field>
    </record>
</odoo>
