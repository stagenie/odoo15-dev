<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Extension du template du rapport de clôture pour ajouter le comptage -->
    <template id="report_treasury_cash_closing_document_extended"
              inherit_id="adi_treasury.report_treasury_cash_closing_document">

        <!-- Ajouter la section Comptage avant le récapitulatif -->
        <xpath expr="//div[hasclass('row') and hasclass('mt-4')][last()]" position="before">

            <!-- Section Comptage (visible seulement si rempli et option d'affichage active) -->
            <t t-if="doc.show_count_in_report and doc.cash_count_done">
                <div class="row mb-4 mt-4">
                    <div class="col-12">
                        <h5 class="bg-light p-2">Comptage de Caisse (Détail du solde réel)</h5>
                    </div>
                </div>

                <div class="row mb-3">
                    <!-- Tableau du comptage -->
                    <div class="col-8">
                        <table class="table table-sm table-bordered">
                            <thead class="bg-light">
                                <tr>
                                    <th>Type</th>
                                    <th>Dénomination</th>
                                    <th class="text-right">Valeur</th>
                                    <th class="text-center">Quantité</th>
                                    <th class="text-right">Sous-total</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="doc.count_line_ids.filtered(lambda l: l.quantity > 0).sorted(lambda l: (l.denomination_type, -l.denomination_value))" t-as="line">
                                    <tr>
                                        <td>
                                            <t t-if="line.denomination_type == 'bill'">Billet</t>
                                            <t t-else="">Pièce</t>
                                        </td>
                                        <td><t t-esc="line.denomination_id.name"/></td>
                                        <td class="text-right">
                                            <span t-field="line.denomination_value"
                                                  t-options='{"widget": "monetary", "display_currency": doc.currency_id}'/>
                                        </td>
                                        <td class="text-center"><t t-esc="line.quantity"/></td>
                                        <td class="text-right">
                                            <span t-field="line.subtotal"
                                                  t-options='{"widget": "monetary", "display_currency": doc.currency_id}'/>
                                        </td>
                                    </tr>
                                </t>
                            </tbody>
                            <tfoot class="bg-light font-weight-bold">
                                <tr>
                                    <td colspan="4" class="text-right">TOTAL COMPTÉ</td>
                                    <td class="text-right">
                                        <span t-field="doc.counted_total"
                                              t-options='{"widget": "monetary", "display_currency": doc.currency_id}'/>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <!-- Récapitulatif comptage -->
                    <div class="col-4">
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Solde théorique :</strong></td>
                                <td class="text-right">
                                    <span t-field="doc.balance_end_theoretical"
                                          t-options='{"widget": "monetary", "display_currency": doc.currency_id}'/>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Solde compté :</strong></td>
                                <td class="text-right">
                                    <span t-field="doc.counted_total"
                                          t-options='{"widget": "monetary", "display_currency": doc.currency_id}'/>
                                </td>
                            </tr>
                            <tr t-att-class="'table-warning' if doc.difference != 0 else 'table-success'">
                                <td><strong>Écart :</strong></td>
                                <td class="text-right">
                                    <span t-field="doc.difference"
                                          t-options='{"widget": "monetary", "display_currency": doc.currency_id}'
                                          t-att-class="'text-danger' if doc.difference != 0 else 'text-success'"/>
                                </td>
                            </tr>
                        </table>
                        <t t-if="doc.difference != 0">
                            <div class="alert alert-warning text-center">
                                <i class="fa fa-exclamation-triangle"/>
                                Écart détecté
                            </div>
                        </t>
                        <t t-else="">
                            <div class="alert alert-success text-center">
                                <i class="fa fa-check"/>
                                Solde vérifié
                            </div>
                        </t>
                    </div>
                </div>
            </t>

        </xpath>

    </template>

</odoo>
